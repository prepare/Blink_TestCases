<!DOCTYPE html>
<html>
<head>
<title>
  hasPermission when called in service worker resolves with denied when permission is denied
</title>
<link rel="manifest" href="resources/push_manifest.json">
<script src="../resources/testharness.js"></script>
<script src="../resources/testharnessreport.js"></script>
<script src="../serviceworker/resources/test-helpers.js"></script>
<script src="../notifications/resources/test-helpers.js"></script>
</head>
<body>
<script>
// This test uses the test runner. If running manually, deny permission when prompted.
async_test(function(test) {
    if (window.testRunner)
        testRunner.setPushMessagingPermission(location.origin, false);

    var script = 'resources/instrumentation-service-worker.js';
    var scope = 'resources/scope/' + location.pathname;

    getActiveServiceWorkerWithMessagePort(test, script, scope).then(function(workerInfo) {
        workerInfo.port.postMessage({command: 'hasPermission'});

        workerInfo.port.addEventListener('message', function(event) {
            if (typeof event.data != 'object' || !event.data.command)
                assert_unreached('Invalid message from the service worker');

            assert_equals(event.data.command, 'hasPermission');
            assert_true(event.data.success,
                        'hasPermission should succeed. Error message: ' + event.data.errorMessage);
            assert_equals(event.data.permission, 'denied');

            test.done();
        });
    }).catch(unreached_rejection(test));
}, 'hasPermission when called in service worker resolves with denied when permission is denied');
</script>
</body>
</html>
